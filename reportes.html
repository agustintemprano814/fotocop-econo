<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Fotocop-Econo | Centro de Auditor√≠a</title>
    <link rel="stylesheet" href="style.css">
    <link rel="icon" type="image/jpg" href="https://linktr.ee/og/image/franjaeconounlp.jpg">
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <style>
        .report-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .report-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: var(--shadow);
            border-top: 5px solid var(--primary);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            transition: 0.3s;
        }
        .report-card:hover { transform: translateY(-3px); }

        .period-selector {
            background: #f8fafc;
            padding: 20px;
            border-radius: 12px;
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            align-items: center;
            border: 1px solid #e2e8f0;
            margin-bottom: 20px;
        }

        .filter-item { display: flex; flex-direction: column; gap: 5px; }
        .filter-item label { font-size: 0.75rem; font-weight: bold; color: var(--primary); text-transform: uppercase; }
        .filter-item select { padding: 8px; border-radius: 6px; border: 1px solid #cbd5e1; }

        .btn-download {
            background: white;
            color: var(--secondary);
            border: 2px solid var(--secondary);
            padding: 10px;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 15px;
            transition: 0.3s;
        }
        .btn-download:hover { background: var(--secondary); color: white; }
    </style>
</head>
<body>
    <div class="sidebar" id="sidebar"></div>

    <main class="main-content">
        <div class="container">
            <h2 style="margin-bottom: 25px;">üìä Centro de Auditor√≠a y Reportes</h2>

            <div class="period-selector">
                <div class="filter-item">
                    <label>Sector:</label>
                    <select id="selectSector">
                        <option value="Todos">Global (Todo)</option>
                        <option value="Apuntes">Sector Apuntes</option>
                        <option value="Fotocopiadora">Sector Fotocopiadora</option>
                    </select>
                </div>
                <div class="filter-item">
                    <label>Mes:</label>
                    <select id="selectMes">
                        <option value="0">Enero</option><option value="1">Febrero</option>
                        <option value="2">Marzo</option><option value="3">Abril</option>
                        <option value="4">Mayo</option><option value="5">Junio</option>
                        <option value="6">Julio</option><option value="7">Agosto</option>
                        <option value="8">Septiembre</option><option value="9">Octubre</option>
                        <option value="10">Noviembre</option><option value="11">Diciembre</option>
                    </select>
                </div>
                <div class="filter-item">
                    <label>A√±o:</label>
                    <select id="selectAnio">
                        <option value="2025">2025</option>
                        <option value="2024">2024</option>
                    </select>
                </div>
            </div>

            <div class="report-grid">
                <div class="report-card">
                    <div>
                        <h3>üí∞ Cierres de Caja</h3>
                        <p style="font-size:0.85rem; color:var(--gray)">Conciliaci√≥n de efectivo, transferencias y diferencias por sector (Apuntes/Foto).</p>
                    </div>
                    <button class="btn-download" onclick="exportar('cierres_diarios', 'Auditoria_Cajas')">üì• Descargar Excel</button>
                </div>

                <div class="report-card" style="border-top-color: var(--accent);">
                    <div>
                        <h3>üñ®Ô∏è Consumo T√©cnico</h3>
                        <p style="font-size:0.85rem; color:var(--gray)">Contadores de m√°quinas, hojas netas impresas y detalle de copias no cobradas.</p>
                    </div>
                    <button class="btn-download" onclick="exportar('cierres_diarios', 'Consumo_Tecnico_Maquinas')">üì• Descargar Excel</button>
                </div>

                <div class="report-card" style="border-top-color: #28a745;">
                    <div>
                        <h3>üìà Detalle de Ventas</h3>
                        <p style="font-size:0.85rem; color:var(--gray)">Historial de tickets individuales emitidos en el mostrador para an√°lisis de productos.</p>
                    </div>
                    <button class="btn-download" onclick="exportar('ventas', 'Historico_Ventas')">üì• Descargar Excel</button>
                </div>

                <div class="report-card" style="border-top-color: var(--dark);">
                    <div>
                        <h3>üì¶ Movimientos de Stock</h3>
                        <p style="font-size:0.85rem; color:var(--gray)">Consumo de resmas, t√≥ner y variaciones de inventario de apuntes.</p>
                    </div>
                    <button class="btn-download" onclick="exportar('stock_movimientos', 'Auditoria_Stock')">üì• Descargar Excel</button>
                </div>
            </div>
        </div>
    </main>

    <script type="module">
        import { db } from './firebase-config.js';
        import { collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { cargarSidebar } from './sidebar.js';
        import { verificarAcceso } from './security.js';

        verificarAcceso(['adm-eco', 'superusuario']).then(() => {
            cargarSidebar('reportes');
        });

        // Funci√≥n Maestra para Aplanar Objetos (M1, M2, Caja, etc)
        function aplanarObjeto(obj, prefijo = '') {
            let res = {};
            for (let k in obj) {
                let prop = prefijo ? `${prefijo}_${k}` : k;
                if (typeof obj[k] === 'object' && obj[k] !== null && !Array.isArray(obj[k])) {
                    Object.assign(res, aplanarObjeto(obj[k], prop));
                } else {
                    res[prop] = obj[k];
                }
            }
            return res;
        }

        window.exportar = async (coleccion, nombreArchivo) => {
            const mes = parseInt(document.getElementById('selectMes').value);
            const anio = parseInt(document.getElementById('selectAnio').value);
            const fechaFiltro = `${anio}-${(mes + 1).toString().padStart(2, '0')}`; // Formato YYYY-MM

            const btn = event.currentTarget;
            btn.disabled = true;
            btn.innerText = "‚è≥ Procesando...";

            try {
                const q = query(collection(db, coleccion));
                const snap = await getDocs(q);
                const datos = [];

                snap.forEach(doc => {
                    const raw = doc.data();
                    // Filtro manual por fechaString (YYYY-MM-DD) para evitar problemas de √≠ndices complejos
                    if (raw.fechaString && raw.fechaString.startsWith(fechaFiltro)) {
                        const plano = aplanarObjeto(raw);
                        datos.push({ ID: doc.id, ...plano });
                    }
                });

                if (datos.length === 0) {
                    alert("No hay registros para este per√≠odo.");
                } else {
                    const ws = XLSX.utils.json_to_sheet(datos);
                    const wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, ws, "Datos");
                    XLSX.writeFile(wb, `${nombreArchivo}_${fechaFiltro}.xlsx`);
                }
            } catch (e) {
                console.error(e);
                alert("Error al exportar.");
            } finally {
                btn.disabled = false;
                btn.innerText = "üì• Descargar Excel";
            }
        };
    </script>
</body>
</html>