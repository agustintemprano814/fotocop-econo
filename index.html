<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fotocopiadora Econ√≥micas UNLP | Acceso</title>
    <link rel="stylesheet" href="style.css">
    <link rel="icon" type="image/jpg" href="https://linktr.ee/og/image/franjaeconounlp.jpg">
    
    <style>
        /* Estilos espec√≠ficos de refuerzo para el Log-in */
        body.login-body { 
            justify-content: center; 
            align-items: center; 
            height: 100vh; 
            display: flex; 
            margin: 0;
            overflow: hidden;
        }

        .login-card { 
            width: 100%; 
            max-width: 400px; 
            animation: slideUp 0.6s ease-out;
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .brand-subtitle {
            text-align: center; 
            color: var(--primary); 
            font-weight: 800; 
            font-size: 11px; 
            margin-bottom: 5px; 
            letter-spacing: 2px;
            text-transform: uppercase;
        }

        .brand-description {
            text-align: center; 
            color: var(--gray); 
            font-size: 12px; 
            margin-bottom: 30px;
        }
    </style>
</head>
<body class="login-body"> 
    <div class="container login-card">
        <div class="logo-container">
            <img src="https://linktr.ee/og/image/franjaeconounlp.jpg" alt="Logo Franja Morada">
        </div>
        
        <h2 style="text-align: center; border: none; padding: 0; margin-bottom: 5px;">Acceso al Sistema</h2>
        <p class="brand-subtitle">Franja Morada Econ√≥micas</p>
        <p class="brand-description">Gesti√≥n Integral de Fotocopiadora</p>
        
        <form id="loginForm">
            <div class="form-group">
                <label for="usuario">Correo Institucional</label>
                <input type="email" id="usuario" placeholder="ejemplo@economicas.unlp.edu.ar" required autocomplete="username">
            </div>
            <div class="form-group">
                <label for="password">Contrase√±a</label>
                <input type="password" id="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required autocomplete="current-password">
            </div>
            <button type="submit" id="btnIngresar" class="btn btn-primary">
                <span>üîê Entrar al Sistema</span>
            </button>
        </form>
        
        <div id="mensaje" class="toast-notification" style="position: static; transform: none; margin-top: 20px; width: 100%; text-align: center; border-radius: 8px;"></div>
    </div>

    <script type="module">
    import { auth, db } from './firebase-config.js';
    import { setPersistence, browserSessionPersistence, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { doc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    // Importamos la herramienta de sanitizaci√≥n de nuestro security centralizado
    import { sanitizar } from './security.js';

    const loginForm = document.getElementById('loginForm');
    const mensaje = document.getElementById('mensaje');
    const btn = document.getElementById('btnIngresar');

    // Al cargar el login, nos aseguramos de que no queden restos de sesiones previas
    window.onload = () => { auth.signOut(); };

    // Manejo de mensajes por par√°metros de URL (Inactividad, etc.)
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('reason') === 'timeout') {
        mostrarMensaje("‚è≥ Sesi√≥n cerrada por inactividad.", "var(--accent)");
    }

    function mostrarMensaje(texto, color) {
        mensaje.innerText = texto;
        mensaje.style.borderLeftColor = color;
        mensaje.classList.add('show');
    }

    loginForm.onsubmit = async (e) => {
        e.preventDefault();
        
        // Bloqueo de UI para evitar m√∫ltiples clics (Ataque de fuerza bruta local)
        btn.disabled = true;
        mostrarMensaje("‚è≥ Validando credenciales...", "var(--primary)");

        // Sanitizaci√≥n de entradas (Blindaje Paso 2)
        const email = sanitizar(document.getElementById('usuario').value.trim().toLowerCase());
        const pass = document.getElementById('password').value;

        try {
            // Establecemos persistencia solo por sesi√≥n del navegador (Seguridad en equipos compartidos)
            await setPersistence(auth, browserSessionPersistence);
            
            // Intento de Login
            const userCredential = await signInWithEmailAndPassword(auth, email, pass);
            const user = userCredential.user;

            // Verificaci√≥n de doble factor l√≥gica: ¬øExiste el usuario en nuestra DB de Roles?
            const docSnap = await getDoc(doc(db, "usuarios", user.email));

            if (docSnap.exists()) {
                const rol = docSnap.data().rol;
                mostrarMensaje(`‚úÖ Bienvenido, nivel: ${rol}`, "var(--success)");
                
                // Redirecci√≥n limpia
                setTimeout(() => { window.location.href = "inicio.html"; }, 1000);
            } else {
                // Usuario existe en Auth pero no en nuestra base de datos (Posible intruso)
                throw new Error("no-role");
            }

        } catch (error) {
            btn.disabled = false;
            console.error("Auth Error:", error.code);

            if (error.message === "no-role") {
                mostrarMensaje("‚ö†Ô∏è Cuenta sin permisos de acceso.", "var(--accent)");
                await auth.signOut();
            } else if (error.code === 'auth/invalid-credential' || error.code === 'auth/user-not-found') {
                mostrarMensaje("‚ùå Credenciales incorrectas.", "var(--danger)");
            } else if (error.code === 'auth/too-many-requests') {
                mostrarMensaje("üö´ Demasiados intentos. Bloqueado temporalmente.", "var(--danger)");
            } else {
                mostrarMensaje("‚ùå Error de conexi√≥n al servidor.", "var(--danger)");
            }
        }
    };
    </script>
</body>
</html>