<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Fotocop-Econo | Panel Principal</title>
    <link rel="stylesheet" href="style.css">
    <link rel="icon" type="image/jpg" href="https://linktr.ee/og/image/franjaeconounlp.jpg">
    <style>
        .module-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 25px;
            margin-top: 30px;
        }
        
          .module-card {
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            border-left: 0px solid var(--primary);
            padding-left: 25px !important;
        }
        
        .module-card:hover {
            transform: translateY(-5px);
            border-left: 10px solid var(--primary);
            padding-left: 30px !important;
            box-shadow: var(--shadow);
        }

        .module-options {
            max-height: 0;
            overflow: hidden;
            transition: all 0.5s ease;
            opacity: 0;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .module-card.expanded .module-options {
            max-height: 400px;
            opacity: 1;
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid rgba(0,0,0,0.05);
        }

        /* --- KPIs --- */
        .kpi-card {
            border-top: 5px solid var(--primary) !important;
            background: white;
            padding: 20px;
            display: none; 
            text-align: left;
        }

        .kpi-title {
            font-size: 0.75rem;
            color: var(--gray);
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
            display: block;
            margin-bottom: 5px;
        }

        .kpi-line {
            width: 45px; 
            height: 3px;
            background-color: var(--accent);
            margin-bottom: 15px;
            border-radius: 2px;
        }

        .kpi-value {
            font-size: 1.4rem; 
            color: var(--dark);
            font-weight: 700;
            margin: 0;
        }

        .module-icon { font-size: 2.2rem; margin-bottom: 10px; display: block; }
    </style>
</head>
<body>
    <div class="sidebar" id="sidebar"></div>

    <div class="main-content">
        <div class="container">
            <div class="user-welcome">
                <div>
                    <h2 id="saludo" style="border:none; margin:0; padding:0; color: var(--primary); font-size: 1.1rem; letter-spacing: 0.5px;">Cargando identidad...</h2>
                    <p id="fechaHoy" style="color: var(--gray); font-size: 0.9rem; margin-top: 5px;"></p>
                </div>
            </div>

            <div class="kpi-grid">
                <div class="kpi-card" id="kpi-apuntes-caja">
                    <span class="kpi-title">APUNTES | Caja Hoy</span>
                    <div class="kpi-line"></div>
                    <p class="kpi-value" id="val-apuntes-caja">$ 0.00</p>
                </div>
                
                <div class="kpi-card" id="kpi-apuntes-stock">
                    <span class="kpi-title">APUNTES | Alertas Stock</span>
                    <div class="kpi-line"></div>
                    <p class="kpi-value" id="val-apuntes-stock">Consultando...</p>
                </div>

                <div class="kpi-card" id="kpi-foto-caja">
                    <span class="kpi-title">FOTOCOP | Recaudaci√≥n</span>
                    <div class="kpi-line"></div>
                    <p class="kpi-value" id="val-foto-caja">$ 0.00</p>
                </div>

                <div class="kpi-card" id="kpi-foto-maquinas">
                    <span class="kpi-title">FOTOCOP | Estado M√°quinas</span>
                    <div class="kpi-line"></div>
                    <p class="kpi-value" id="val-foto-maquinas">OK</p>
                </div>
            </div>

            <div class="module-grid">
                <div class="card module-card" onclick="toggleModulo(this)">
                    <span class="module-icon">üí∞</span>
                    <h3>Punto de Venta</h3>
                    <p>Facturaci√≥n de servicios y venta de apuntes.</p>
                    <div class="module-options">
                        <button class="btn btn-primary" onclick="window.location.href='ventas.html'">üñ®Ô∏è Sector Fotocopiadora</button>
                        <button class="btn btn-accent" onclick="window.location.href='apuntes.html'">üìö Sector Apuntes</button>
                    </div>
                </div>

                <div class="card module-card" onclick="toggleModulo(this)">
                    <span class="module-icon">üì¶</span>
                    <h3>Gesti√≥n de Almac√©n</h3>
                    <p>Inventario de apuntes e insumos operativos.</p>
                    <div class="module-options">
                        <button class="btn btn-primary" onclick="window.location.href='stock.html'">üõí Control de Stock</button>
                        <button class="btn btn-primary" onclick="window.location.href='insumos.html'">üõ†Ô∏è Insumos Internos</button>
                    </div>
                </div>

                <div class="card module-card" id="moduloAdmin" style="display: none;" onclick="toggleModulo(this)">
                    <span class="module-icon">üìë</span>
                    <h3>Administraci√≥n</h3>
                    <p>Cierres, auditor√≠a y configuraci√≥n del sistema.</p>
                    <div class="module-options">
                        <button class="btn btn-primary" onclick="window.location.href='cierres.html'">üìë Cierres de Caja</button>
                        <button class="btn btn-primary" onclick="window.location.href='reportes.html'">üìÇ Reportes Generales</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { db } from './firebase-config.js';
        import { collection, query, where, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { cargarSidebar } from './sidebar.js';
        import { verificarAcceso, renderSeguro } from './security.js';

        // Definimos los roles autorizados 
        const rolesAutorizados = [
            'superusuario', 'adm-eco', 
            'supervisor-apuntes', 'supervisor-fotocop',
            'operario-apuntes', 'operario-fotocop'
        ];

        verificarAcceso(rolesAutorizados).then(info => {
            cargarSidebar('inicio');
            const rol = info.rol;

            // Inyectamos la Identidad Humanizada (Juan Perez | ROL [UNIDAD])
            renderSeguro(document.getElementById('saludo'), `¬°Hola, ${info.idProfesional}!`);
            
            document.getElementById('fechaHoy').innerText = new Date().toLocaleDateString('es-AR', { 
                weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' 
            });

            // --- L√ìGICA DE VISIBILIDAD DE KPIs POR ROLES SEGMENTADOS ---
            
            // KPIs APUNTES
            if (['superusuario', 'adm-eco', 'supervisor-apuntes', 'operario-apuntes'].includes(rol)) {
                document.getElementById('kpi-apuntes-stock').style.display = 'block';
            }
            if (['superusuario', 'adm-eco', 'supervisor-apuntes'].includes(rol)) {
                document.getElementById('kpi-apuntes-caja').style.display = 'block';
            }

            // KPIs FOTOCOPIADORA
            if (['superusuario', 'adm-eco', 'supervisor-fotocop', 'operario-fotocop'].includes(rol)) {
                document.getElementById('kpi-foto-maquinas').style.display = 'block';
            }
            if (['superusuario', 'adm-eco', 'supervisor-fotocop'].includes(rol)) {
                document.getElementById('kpi-foto-caja').style.display = 'block';
            }

            // MODULO ADMIN
            if (['superusuario', 'adm-eco'].includes(rol)) {
                document.getElementById('moduloAdmin').style.display = 'block';
            }

            actualizarKPIs(info.unidad);
        });

        window.toggleModulo = (card) => {
            const isExpanded = card.classList.contains('expanded');
            document.querySelectorAll('.module-card').forEach(c => c.classList.remove('expanded'));
            if (!isExpanded) card.classList.add('expanded');
        };

        function actualizarKPIs(unidadUsuario) {
            const hoy = new Date().toISOString().split('T')[0];

            // 1. Recaudaci√≥n Apuntes 
            const qApu = query(collection(db, "ventas"), where("fecha", "==", hoy), where("sector", "==", "Apuntes"));
            onSnapshot(qApu, (snap) => {
                let t = 0; 
                snap.forEach(d => {
                    if(unidadUsuario === 'global' || d.data().unidad === unidadUsuario) t += d.data().total;
                });
                renderSeguro(document.getElementById('val-apuntes-caja'), `$ ${t.toLocaleString('es-AR', {minimumFractionDigits: 2})}`);
            });

            // 2. Alertas Stock Apuntes
            onSnapshot(query(collection(db, "stock"), where("cantidad", "<=", 5)), (snap) => {
                let criticos = 0;
                snap.forEach(d => { if(unidadUsuario === 'global' || d.data().unidad === unidadUsuario) criticos++; });
                renderSeguro(document.getElementById('val-apuntes-stock'), criticos > 0 ? `${criticos} CR√çTICOS` : "OK");
            });

            // 3. Recaudaci√≥n Fotocopiadora
            const qFoto = query(collection(db, "ventas"), where("fecha", "==", hoy), where("sector", "==", "Fotocopiadora"));
            onSnapshot(qFoto, (snap) => {
                let t = 0; 
                snap.forEach(d => {
                    if(unidadUsuario === 'global' || d.data().unidad === unidadUsuario) t += d.data().total;
                });
                renderSeguro(document.getElementById('val-foto-caja'), `$ ${t.toLocaleString('es-AR', {minimumFractionDigits: 2})}`);
            });
        }
    </script>
</body>
</html>